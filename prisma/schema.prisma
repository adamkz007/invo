generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

// E-Invoice Enums
enum EInvoiceEnvironment {
  SANDBOX
  PRODUCTION
}

enum EInvoiceStatus {
  PENDING
  SUBMITTED
  VALID
  INVALID
  CANCELLED
}

enum EInvoiceDocumentType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
  REFUND_NOTE
  SELF_BILLED_INVOICE
  SELF_BILLED_CREDIT_NOTE
  SELF_BILLED_DEBIT_NOTE
  SELF_BILLED_REFUND_NOTE
}

enum EInvoiceProfile {
  LHDN
  PEPPOL
}

enum EInvoiceEventType {
  CREATED
  SUBMITTED
  VALIDATED
  INVALID
  CANCELLED
  REJECTED
  RETRIED
  ERROR
}

enum PosOrderStatus {
  KITCHEN
  TO_PAY
  COMPLETED
  CANCELLED
}

enum PosOrderType {
  DINE_IN
  TAKEAWAY
}

model User {
  id                   String             @id @default(cuid())
  name                 String?
  email                String?            @unique
  phoneNumber          String?            @unique
  passwordHash         String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  subscriptionStatus   String?
  trialStartDate       DateTime?
  trialEndDate         DateTime?
  currentPeriodEnd     DateTime?
  company              Company?
  customers            Customer[]
  invoices             Invoice[]
  products             Product[]
  receipts             Receipt[]
  posOrders            PosOrder[]
  posTables            PosTable[]
  posSettings          PosSettings?
  // Accounting
  role                 UserRole           @default(STAFF)
  accounts             Account[]
  journalEntries       JournalEntry[]
  expenses             Expense[]
  bankAccounts         BankAccount[]
  taxRates             TaxRate[]
  auditLogs            AuditLog[]
  // E-Invoice
  eInvoiceConfig       EInvoiceConfig?
  eInvoiceDocuments    EInvoiceDocument[]
}

model Customer {
  id                      String    @id @default(cuid())
  name                    String
  email                   String?
  phoneNumber             String?
  street                  String?
  city                    String?
  postcode                String?
  state                   String?
  country                 String?   @default("Malaysia")
  registrationType        String?   @default("NRIC")
  registrationNumber      String?
  taxIdentificationNumber String?
  notes                   String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  userId                  String
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices                Invoice[]
  // E-Invoice specific fields
  tin                     String?   // Tax Identification Number (for e-invoice)
  brn                     String?   // Business Registration Number
  // PEPPOL specific fields
  peppolParticipantId     String?   // PEPPOL Participant ID
  peppolSchemeId          String?   // PEPPOL Scheme ID (e.g., 0195 for MY)

  @@index([userId, createdAt])
}

model Product {
  id                     String         @id @default(cuid())
  name                   String
  description            String?
  price                  Decimal        @db.Decimal(12, 2)
  quantity               Int            @default(0)
  sku                    String?
  disableStockManagement Boolean        @default(false)
  imageUrl               String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  userId                 String
  invoiceItems           InvoiceItem[]
  user                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  receiptItems           ReceiptItem[]
  posOrderItems          PosOrderItem[]
  // E-Invoice default fields
  unitCode               String?        @default("C62") // UNECE Rec 20 unit code
  classificationCode     String?        // Product classification code (e.g., UNSPSC)
  taxCategoryCode        String?        @default("01") // Default tax category

  @@index([userId, createdAt])
}

model Invoice {
  id                String             @id @default(cuid())
  invoiceNumber     String             @unique
  issueDate         DateTime           @default(now())
  dueDate           DateTime
  status            InvoiceStatus      @default(DRAFT)
  subtotal          Decimal            @db.Decimal(12, 2)
  taxRate           Decimal            @default(0.00) @db.Decimal(5, 2)
  taxAmount         Decimal            @default(0.00) @db.Decimal(12, 2)
  discountRate      Decimal            @default(0.00) @db.Decimal(5, 2)
  discountAmount    Decimal            @default(0.00) @db.Decimal(12, 2)
  total             Decimal            @db.Decimal(12, 2)
  paidAmount        Decimal            @default(0.00) @db.Decimal(12, 2)
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  customerId        String
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer          Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items             InvoiceItem[]
  eInvoiceDocuments EInvoiceDocument[]
  payments          InvoicePayment[]

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([customerId])
}

model InvoicePayment {
  id            String   @id @default(cuid())
  amount        Decimal  @db.Decimal(12, 2)
  paymentDate   DateTime @default(now())
  paymentMethod String   @default("BANK") // BANK, CASH, etc.
  notes         String?
  createdAt     DateTime @default(now())
  invoiceId     String
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId, paymentDate])
  @@map("invoice_payments")
}

model InvoiceItem {
  id                     String   @id @default(cuid())
  quantity               Int
  unitPrice              Decimal  @db.Decimal(12, 2)
  description            String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  invoiceId              String
  productId              String
  product                Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  invoice                Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  // E-Invoice line-level fields
  unitCode               String?  @default("C62") // UNECE Rec 20 unit code (C62 = unit/piece)
  taxCategoryCode        String?  @default("01")  // LHDN tax type code (01 = Sales Tax)
  taxRate                Decimal? @db.Decimal(5, 2) // Line-level tax rate (nullable = use invoice rate)
  taxExemptionReasonCode String?  // Tax exemption reason code
  taxExemptionReason     String?  // Tax exemption reason text
  classificationCode     String?  // Product classification code (e.g., UNSPSC)

  @@index([productId])
  @@index([invoiceId, productId])
}

model Company {
  id                      String   @id @default(cuid())
  legalName               String?
  ownerName               String?
  address                 String?
  phoneNumber             String?
  email                   String?
  registrationNumber      String?
  taxIdentificationNumber String?
  termsAndConditions      String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  userId                  String   @unique
  bankAccountName         String?
  bankAccountNumber       String?
  bankName                String?
  paymentMethod           String?
  qrImageUrl              String?
  msicCode                String?
  city                    String?
  country                 String?  @default("Malaysia")
  postcode                String?
  state                   String?
  street                  String?
  // E-Invoice specific fields (LHDN)
  tin                     String?  // Tax Identification Number (explicit for e-invoice)
  brn                     String?  // Business Registration Number
  sstRegistrationNumber   String?  // SST Registration Number
  tourismTaxNumber        String?  // Tourism Tax Registration Number
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Receipt {
  id            String        @id @default(cuid())
  receiptNumber String        @unique
  customerName  String
  customerPhone String?
  receiptDate   DateTime      @default(now())
  paymentMethod String        @default("CASH")
  total         Decimal       @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         ReceiptItem[]

  @@index([userId, createdAt])
}

model ReceiptItem {
  id          String   @id @default(cuid())
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  receiptId   String
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  receipt     Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// Accounting

enum UserRole {
  ADMIN
  ACCOUNTANT
  STAFF
  VIEWER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
  LOCKED
}

model Account {
  id        String        @id @default(cuid())
  code      String        @unique
  name      String
  type      AccountType
  parentId  String?
  parent    Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children  Account[]     @relation("AccountHierarchy")
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lines     JournalLine[]

  @@index([userId, type])
}

model JournalEntry {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  memo        String?
  source      String // invoice|receipt|expense|bank|manual
  referenceId String?
  status      JournalStatus @default(DRAFT)
  postedAt    DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lines       JournalLine[]

  @@index([userId, date])
  @@index([userId, status])
}

model JournalLine {
  id         String       @id @default(cuid())
  entryId    String
  accountId  String
  debit      Decimal      @default(0.00) @db.Decimal(12, 2)
  credit     Decimal      @default(0.00) @db.Decimal(12, 2)
  entityType String?
  entityId   String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  entry      JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account    Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([entryId])
}

model TaxRate {
  id                    String   @id @default(cuid())
  name                  String
  rate                  Decimal  @default(0.00) @db.Decimal(5, 2)
  jurisdiction          String?
  salesTaxAccountId     String?
  taxLiabilityAccountId String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BankAccount {
  id              String            @id @default(cuid())
  name            String
  currency        String            @default("USD")
  maskedNumber    String?
  provider        String?
  glAccountId     String?
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    BankTransaction[]
  reconciliations Reconciliation[]

  @@index([userId])
}

model BankTransaction {
  id            String      @id @default(cuid())
  bankAccountId String
  date          DateTime
  amount        Decimal     @db.Decimal(12, 2)
  description   String?
  externalRef   String?
  status        String      @default("unmatched")
  matchedLineId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId, date])
}

model Reconciliation {
  id               String      @id @default(cuid())
  bankAccountId    String
  periodStart      DateTime
  periodEnd        DateTime
  statementBalance Decimal     @db.Decimal(12, 2)
  bookBalance      Decimal     @db.Decimal(12, 2)
  difference       Decimal     @db.Decimal(12, 2)
  reconciledAt     DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  bankAccount      BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId, periodStart, periodEnd])
}

model Expense {
  id          String   @id @default(cuid())
  vendor      String
  date        DateTime @default(now())
  subtotal    Decimal  @default(0.00) @db.Decimal(12, 2)
  taxRate     Decimal  @default(0.00) @db.Decimal(5, 2)
  taxAmount   Decimal  @default(0.00) @db.Decimal(12, 2)
  total       Decimal  @default(0.00) @db.Decimal(12, 2)
  notes       String?
  status      String   @default("DRAFT")
  attachments String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model AuditLog {
  id        String   @id @default(cuid())
  entity    String
  entityId  String
  action    String
  timestamp DateTime @default(now())
  userId    String
  before    String?
  after     String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entity, entityId])
}

// POS Models
model PosOrder {
  id          String         @id @default(cuid())
  orderNumber String         @unique
  tableNumber String
  tableId     String?
  status      PosOrderStatus @default(KITCHEN)
  orderType   PosOrderType   @default(DINE_IN)
  subtotal    Decimal        @default(0.00) @db.Decimal(12, 2)
  taxRate     Decimal        @default(0.00) @db.Decimal(5, 2)
  taxAmount   Decimal        @default(0.00) @db.Decimal(12, 2)
  total       Decimal        @default(0.00) @db.Decimal(12, 2)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  table       PosTable?      @relation(fields: [tableId], references: [id], onDelete: SetNull)
  items       PosOrderItem[]

  @@index([userId, createdAt])
  @@index([userId, status])
  @@map("pos_orders")
}

model PosOrderItem {
  id        String   @id @default(cuid())
  quantity  Int
  unitPrice Decimal  @db.Decimal(12, 2)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orderId   String
  productId String
  order     PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("pos_order_items")
}

model PosTable {
  id        String     @id @default(cuid())
  name      String
  label     String?
  isActive  Boolean    @default(true)
  capacity  Int        @default(4)
  positionX Float      @default(0)
  positionY Float      @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    PosOrder[]

  @@map("pos_tables")
}

model PosSettings {
  id                    String   @id @default(cuid())
  autoPrintEnabled      Boolean  @default(false)
  defaultPrinterAddress String?
  tableLayoutType       String   @default("LIST") // LIST, MAP
  taxRate               Decimal  @default(0.00) @db.Decimal(5, 2)
  serviceChargeRate     Decimal  @default(0.00) @db.Decimal(5, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pos_settings")
}

// E-Invoice Models
model EInvoiceConfig {
  id                       String              @id @default(cuid())
  enabled                  Boolean             @default(false)
  environment              EInvoiceEnvironment @default(SANDBOX)
  // MyInvois credentials (encrypted in practice)
  myinvoisClientId         String?
  myinvoisClientSecretHash String?
  // Supplier identity for LHDN
  supplierTin              String?
  supplierBrn              String?
  sstRegistrationNumber    String?
  tourismTaxNumber         String?
  // Default settings
  defaultCurrencyCode      String              @default("MYR")
  autoSubmitOnSend         Boolean             @default(false)
  // PEPPOL settings
  peppolParticipantId      String?
  peppolSchemeId           String?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  userId                   String              @unique
  user                     User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("einvoice_config")
}

model EInvoiceDocument {
  id                   String               @id @default(cuid())
  invoiceId            String
  profile              EInvoiceProfile      @default(LHDN)
  documentType         EInvoiceDocumentType @default(INVOICE)
  documentVersion      String               @default("1.0")
  format               String               @default("XML") // XML or JSON
  // Snapshot of data used to generate the document
  canonicalDataSnapshot String?             @db.Text
  // Signed payload (base64 encoded)
  signedPayloadBase64  String?              @db.Text
  documentHash         String?
  // MyInvois identifiers
  submissionId         String?
  myinvoisDocumentId   String?
  myinvoisLongId       String?
  // Status and validation
  status               EInvoiceStatus       @default(PENDING)
  validationErrors     String?              @db.Text // JSON array of errors
  validatedAt          DateTime?
  // Timestamps
  submittedAt          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  userId               String
  invoice              Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  events               EInvoiceEvent[]

  @@index([invoiceId])
  @@index([userId, status])
  @@index([submissionId])
  @@map("einvoice_documents")
}

model EInvoiceEvent {
  id                 String            @id @default(cuid())
  eInvoiceDocumentId String
  eventType          EInvoiceEventType
  payload            String?           @db.Text // JSON payload with event details
  errorMessage       String?
  createdAt          DateTime          @default(now())
  document           EInvoiceDocument  @relation(fields: [eInvoiceDocumentId], references: [id], onDelete: Cascade)

  @@index([eInvoiceDocumentId, createdAt])
  @@map("einvoice_events")
}
